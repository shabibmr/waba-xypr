services:
  # ==================== Core Services ====================

  tenant-service:
    build:
      context: .
      dockerfile: ./services/tenant-service/Dockerfile
      target: development
    container_name: whatsapp-tenant-service
    ports:
      - "3007:3007"
    environment:
      PORT: 3007
      NODE_ENV: development
      REDIS_URL: redis://192.168.29.124:6379
      DB_HOST: 192.168.29.124
      DB_PORT: 5432
      DB_NAME: whatsapp_genesys
      DB_USER: postgres
      DB_PASSWORD: ${DB_PASSWORD:-secure_password}
    restart: unless-stopped
    networks:
      - whatsapp_network

  auth-service:
    build:
      context: .
      dockerfile: ./services/auth-service/Dockerfile
      target: development
    container_name: whatsapp-auth-service
    ports:
      - "3004:3004"
    environment:
      PORT: 3004
      NODE_ENV: development
      REDIS_URL: redis://192.168.29.124:6379
      TENANT_SERVICE_URL: http://tenant-service:3007
      GENESYS_CLIENT_ID: ${GENESYS_CLIENT_ID}
      GENESYS_CLIENT_SECRET: ${GENESYS_CLIENT_SECRET}
      GENESYS_REGION: ${GENESYS_REGION:-mypurecloud.com}
      # Fix: removed dead port 3013, added admin-dashboard port 3006, use REMOTE_HOST for remote deployment
      ALLOWED_ORIGINS: http://${REMOTE_HOST:-192.168.29.124}:3006,http://${REMOTE_HOST:-192.168.29.124}:3012,http://${REMOTE_HOST:-192.168.29.124}:3014
    depends_on:
      - tenant-service
    restart: unless-stopped
    networks:
      - whatsapp_network

  state-manager:
    build:
      context: .
      dockerfile: ./services/state-manager/Dockerfile
      target: development
    container_name: whatsapp-state-manager
    ports:
      - "3005:3005"
    environment:
      PORT: 3005
      NODE_ENV: production
      REDIS_URL: redis://192.168.29.124:6379
      RABBITMQ_URL: amqp://${RABBITMQ_USER:-admin}:${RABBITMQ_PASSWORD:-admin123}@192.168.29.124:5672
      DB_HOST: 192.168.29.124
      DB_PORT: 5432
      DB_NAME: whatsapp_genesys
      DB_USER: postgres
      DB_PASSWORD: ${DB_PASSWORD:-secure_password}
    restart: unless-stopped
    networks:
      - whatsapp_network

  # ==================== WhatsApp Services ====================

  whatsapp-webhook-service:
    build:
      context: .
      dockerfile: ./services/whatsapp-webhook-service/Dockerfile
      target: development
    container_name: whatsapp-webhook
    ports:
      - "3009:3009"
    environment:
      PORT: 3009
      NODE_ENV: development
      RABBITMQ_URL: amqp://${RABBITMQ_USER:-admin}:${RABBITMQ_PASSWORD:-admin123}@192.168.29.124:5672
      META_VERIFY_TOKEN: ${META_VERIFY_TOKEN}
      TENANT_SERVICE_URL: http://tenant-service:3007
      MINIO_ENDPOINT: 192.168.29.124
      MINIO_PORT: 9000
      MINIO_ACCESS_KEY: ${MINIO_ROOT_USER:-admin}
      MINIO_SECRET_KEY: ${MINIO_ROOT_PASSWORD:-admin123}
      MINIO_BUCKET: whatsapp-media
    depends_on:
      - tenant-service
    restart: unless-stopped
    networks:
      - whatsapp_network

  whatsapp-api-service:
    build:
      context: .
      dockerfile: ./services/whatsapp-api-service/Dockerfile
      target: development
    container_name: whatsapp-api
    ports:
      - "3008:3008"
    environment:
      PORT: 3008
      NODE_ENV: development
      REDIS_URL: redis://192.168.29.124:6379
      TENANT_SERVICE_URL: http://tenant-service:3007
      RABBITMQ_URL: amqp://${RABBITMQ_USER:-admin}:${RABBITMQ_PASSWORD:-admin123}@192.168.29.124:5672
    depends_on:
      - tenant-service
    restart: unless-stopped
    networks:
      - whatsapp_network

  # ==================== Genesys Services ====================

  genesys-webhook-service:
    build:
      context: .
      dockerfile: ./services/genesys-webhook-service/Dockerfile
      target: development
    container_name: genesys-webhook
    ports:
      - "3011:3011"
    environment:
      PORT: 3011
      NODE_ENV: development
      RABBITMQ_URL: amqp://${RABBITMQ_USER:-admin}:${RABBITMQ_PASSWORD:-admin123}@192.168.29.124:5672
      STATE_SERVICE_URL: http://state-manager:3005
      TENANT_SERVICE_URL: http://tenant-service:3007
      MINIO_ENDPOINT: 192.168.29.124
      MINIO_PORT: 9000
      MINIO_ACCESS_KEY: ${MINIO_ROOT_USER:-admin}
      MINIO_SECRET_KEY: ${MINIO_ROOT_PASSWORD:-admin123}
      MINIO_BUCKET: whatsapp-media
    depends_on:
      - state-manager
      - tenant-service
    restart: unless-stopped
    networks:
      - whatsapp_network

  genesys-api-service:
    build:
      context: .
      dockerfile: ./services/genesys-api-service/Dockerfile
      target: development
    container_name: genesys-api
    ports:
      - "3010:3010"
    environment:
      PORT: 3010
      NODE_ENV: development
      REDIS_URL: redis://192.168.29.124:6379
      # Fix: added missing RABBITMQ_URL — service consumes from genesys.outbound.ready queue
      RABBITMQ_URL: amqp://${RABBITMQ_USER:-admin}:${RABBITMQ_PASSWORD:-admin123}@192.168.29.124:5672
      TENANT_SERVICE_URL: http://tenant-service:3007
      AUTH_SERVICE_URL: http://auth-service:3004
    depends_on:
      - tenant-service
      - auth-service
    restart: unless-stopped
    networks:
      - whatsapp_network

  # ==================== Transformer Services ====================

  inbound-transformer:
    build:
      context: .
      dockerfile: ./services/inbound-transformer/Dockerfile
      target: development
    container_name: whatsapp-inbound-transformer
    ports:
      - "3002:3002"
    environment:
      PORT: 3002
      NODE_ENV: development
      RABBITMQ_URL: amqp://${RABBITMQ_USER:-admin}:${RABBITMQ_PASSWORD:-admin123}@192.168.29.124:5672
      STATE_SERVICE_URL: http://state-manager:3005
      GENESYS_API_URL: http://genesys-api:3010
    depends_on:
      - state-manager
      - genesys-api-service
    restart: unless-stopped
    networks:
      - whatsapp_network

  outbound-transformer:
    build:
      context: .
      dockerfile: ./services/outbound-transformer/Dockerfile
      target: development
    container_name: whatsapp-outbound-transformer
    ports:
      - "3003:3003"
    environment:
      PORT: 3003
      NODE_ENV: development
      RABBITMQ_URL: amqp://${RABBITMQ_USER:-admin}:${RABBITMQ_PASSWORD:-admin123}@192.168.29.124:5672
      STATE_SERVICE_URL: http://state-manager:3005
      TENANT_SERVICE_URL: http://tenant-service:3007
      WHATSAPP_API_URL: http://whatsapp-api:3008
    depends_on:
      - state-manager
      - whatsapp-api-service
    restart: unless-stopped
    networks:
      - whatsapp_network

  # ==================== API Gateway ====================

  api-gateway:
    build:
      context: .
      dockerfile: ./services/api-gateway/Dockerfile
      target: development
    container_name: whatsapp-api-gateway
    ports:
      - "3000:3000"
    environment:
      PORT: 3000
      NODE_ENV: development
      REDIS_URL: redis://192.168.29.124:6379
      WHATSAPP_WEBHOOK_URL: http://whatsapp-webhook:3009
      WHATSAPP_API_URL: http://whatsapp-api:3008
      GENESYS_WEBHOOK_URL: http://genesys-webhook:3011
      GENESYS_API_URL: http://genesys-api:3010
      TENANT_SERVICE_URL: http://tenant-service:3007
      AUTH_SERVICE_URL: http://auth-service:3004
      STATE_SERVICE_URL: http://state-manager:3005
      AGENT_PORTAL_SERVICE_URL: http://agent-portal-service:3015
      # Fix: removed dead port 3013 and dev-only port 5173, added 3006, use REMOTE_HOST
      ALLOWED_ORIGINS: http://${REMOTE_HOST:-192.168.29.124}:3006,http://${REMOTE_HOST:-192.168.29.124}:3012,http://${REMOTE_HOST:-192.168.29.124}:3014
    depends_on:
      - tenant-service
      - auth-service
    restart: unless-stopped
    networks:
      - whatsapp_network

  # ==================== Frontend Services ====================

  agent-widget:
    build:
      context: .
      dockerfile: ./services/agent-widget/Dockerfile
    container_name: whatsapp-agent-widget
    ports:
      - "3012:3012"
    environment:
      PORT: 3012
      NODE_ENV: development
      STATE_SERVICE_URL: http://state-manager:3005
      WHATSAPP_API_URL: http://whatsapp-api:3008
      # Fix: replaced localhost with remote server IP
      PUBLIC_URL: ${WIDGET_PUBLIC_URL:-http://192.168.29.124:3012}
      ALLOWED_ORIGINS: http://${REMOTE_HOST:-192.168.29.124}:3014,http://${REMOTE_HOST:-192.168.29.124}:3000
    depends_on:
      - state-manager
      - whatsapp-api-service
    restart: unless-stopped
    networks:
      - whatsapp_network

  admin-dashboard:
    build:
      context: .
      dockerfile: ./services/admin-dashboard/Dockerfile
    container_name: whatsapp-admin-dashboard
    ports:
      - "3006:80"
    environment:
      # Fix: replaced localhost with REMOTE_HOST so browsers can reach the gateway
      REACT_APP_API_GATEWAY: http://${REMOTE_HOST:-192.168.29.124}:3000
      VITE_API_GATEWAY: http://${REMOTE_HOST:-192.168.29.124}:3000
      VITE_META_APP_ID: ${META_APP_ID}
      VITE_META_CONFIG_ID: ${META_CONFIG_ID}
    depends_on:
      - api-gateway
    restart: unless-stopped
    networks:
      - whatsapp_network

  agent-portal:
    build:
      context: .
      dockerfile: ./services/agent-portal/Dockerfile
      target: development
    container_name: whatsapp-agent-portal
    ports:
      - "3014:3014"
    volumes:
      - ./services/agent-portal:/app/services/agent-portal
      - /app/services/agent-portal/node_modules
    environment:
      PORT: 3014
      # Fix: was pointing to port 3015 (agent-portal-service); must go through api-gateway on 3000
      VITE_API_GATEWAY: http://${REMOTE_HOST:-192.168.29.124}:3000
      # Fix: was pointing to port 3015 (wrong service); agent-widget WebSocket is on 3012
      VITE_AGENT_WIDGET_URL: ws://${REMOTE_HOST:-192.168.29.124}:3012
      VITE_GENESYS_REGION: ${GENESYS_REGION:-mypurecloud.com}
      # Fix: use ${META_APP_ID} / ${META_CONFIG_ID} consistent with admin-dashboard
      VITE_META_APP_ID: ${META_APP_ID}
      VITE_META_CONFIG_ID: ${META_CONFIG_ID}
    command: npm run dev -- --host --port 3014
    depends_on:
      - api-gateway
      - agent-portal-service  # Fix: added missing dependency
    restart: unless-stopped
    networks:
      - whatsapp_network

  agent-portal-service:
    build:
      context: .
      dockerfile: ./services/agent-portal-service/Dockerfile
      target: development
    container_name: whatsapp-agent-portal-service
    ports:
      - "3015:3015"
    environment:
      PORT: 3015
      NODE_ENV: development
      DATABASE_URL: postgresql://postgres:${DB_PASSWORD:-secure_password}@192.168.29.124:5432/whatsapp_genesys
      REDIS_URL: redis://192.168.29.124:6379
      RABBITMQ_URL: amqp://${RABBITMQ_USER:-admin}:${RABBITMQ_PASSWORD:-admin123}@192.168.29.124:5672
      JWT_SECRET: ${JWT_SECRET:-your_secret_key_here_change_in_production}
      JWT_EXPIRES_IN: 7d
      GENESYS_CLIENT_ID: ${GENESYS_CLIENT_ID}
      GENESYS_CLIENT_SECRET: ${GENESYS_CLIENT_SECRET}
      GENESYS_REGION: ${GENESYS_REGION:-mypurecloud.com}
      # Fix: replaced localhost default — OAuth callback must be reachable by Genesys Cloud
      GENESYS_REDIRECT_URI: ${GENESYS_AGENT_REDIRECT_URI:-http://192.168.29.124:3000/api/agents/auth/callback}
      AUTH_SERVICE_URL: http://auth-service:3004
      TENANT_SERVICE_URL: http://tenant-service:3007
      AGENT_WIDGET_URL: http://agent-widget:3012
      STATE_MANAGER_URL: http://state-manager:3005
      WHATSAPP_API_URL: http://whatsapp-api:3008
      # Fix: replaced localhost with REMOTE_HOST
      AGENT_PORTAL_FRONTEND_URL: http://${REMOTE_HOST:-192.168.29.124}:3014
      # Fix: replaced localhost with REMOTE_HOST, removed dev-only port 5173
      ALLOWED_ORIGINS: http://${REMOTE_HOST:-192.168.29.124}:3014,http://${REMOTE_HOST:-192.168.29.124}:3000
    depends_on:
      - tenant-service
      - auth-service
    restart: unless-stopped
    networks:
      - whatsapp_network

# ==================== Networks ====================

networks:
  whatsapp_network:
    driver: bridge
    name: whatsapp_genesys_network
