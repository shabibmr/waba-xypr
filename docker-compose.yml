services:
  # ==================== Infrastructure Services ====================
  
  postgres:
    image: postgres:15-alpine
    container_name: whatsapp-postgres
    environment:
      POSTGRES_DB: whatsapp_genesys
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${DB_PASSWORD:-secure_password}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - whatsapp_network

  redis:
    image: redis:7-alpine
    container_name: whatsapp-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - whatsapp_network

  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: whatsapp-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-admin}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-admin123}
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: unless-stopped
    networks:
      - whatsapp_network

  minio:
    image: minio/minio
    container_name: whatsapp-minio
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-admin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-admin123}
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    restart: unless-stopped
    networks:
      - whatsapp_network

  createbuckets:
    image: minio/mc
    container_name: whatsapp-createbuckets
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      /usr/bin/mc config host add myminio http://minio:9000 ${MINIO_ROOT_USER:-admin} ${MINIO_ROOT_PASSWORD:-admin123};
      /usr/bin/mc mb myminio/whatsapp-media;
      /usr/bin/mc anonymous set public myminio/whatsapp-media;
      exit 0;
      "
    networks:
      - whatsapp_network

  # ==================== Core Services ====================

  tenant-service:
    build:
      context: .
      dockerfile: ./services/tenant-service/Dockerfile
    container_name: whatsapp-tenant-service
    ports:
      - "3007:3007"
    environment:
      PORT: 3007
      NODE_ENV: development
      REDIS_URL: redis://redis:6379
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: whatsapp_genesys
      DB_USER: postgres
      DB_PASSWORD: ${DB_PASSWORD:-secure_password}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - whatsapp_network

  auth-service:
    build:
      context: .
      dockerfile: ./services/auth-service/Dockerfile
    container_name: whatsapp-auth-service
    ports:
      - "3004:3004"
    environment:
      PORT: 3004
      NODE_ENV: development
      REDIS_URL: redis://redis:6379
      TENANT_SERVICE_URL: http://tenant-service:3007
      GENESYS_CLIENT_ID: ${GENESYS_CLIENT_ID}
      GENESYS_CLIENT_SECRET: ${GENESYS_CLIENT_SECRET}
      GENESYS_REGION: ${GENESYS_REGION:-mypurecloud.com}
    depends_on:
      redis:
        condition: service_healthy
      tenant-service:
        condition: service_started
    restart: unless-stopped
    networks:
      - whatsapp_network

  state-manager:
    build:
      context: .
      dockerfile: ./services/state-manager/Dockerfile
    container_name: whatsapp-state-manager
    ports:
      - "3005:3005"
    environment:
      PORT: 3005
      NODE_ENV: development
      REDIS_URL: redis://redis:6379
      RABBITMQ_URL: amqp://${RABBITMQ_USER:-admin}:${RABBITMQ_PASSWORD:-admin123}@rabbitmq:5672
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: whatsapp_genesys
      DB_USER: postgres
      DB_PASSWORD: ${DB_PASSWORD:-secure_password}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - whatsapp_network

  # ==================== WhatsApp Services ====================

  whatsapp-webhook-service:
    build:
      context: .
      dockerfile: ./services/whatsapp-webhook-service/Dockerfile
    container_name: whatsapp-webhook
    ports:
      - "3009:3009"
    environment:
      PORT: 3009
      NODE_ENV: development
      RABBITMQ_URL: amqp://${RABBITMQ_USER:-admin}:${RABBITMQ_PASSWORD:-admin123}@rabbitmq:5672
      META_VERIFY_TOKEN: ${META_VERIFY_TOKEN}
      TENANT_SERVICE_URL: http://tenant-service:3007
      MINIO_ENDPOINT: minio
      MINIO_PORT: 9000
      MINIO_ACCESS_KEY: ${MINIO_ROOT_USER:-admin}
      MINIO_SECRET_KEY: ${MINIO_ROOT_PASSWORD:-admin123}
      MINIO_BUCKET: whatsapp-media
    depends_on:
      rabbitmq:
        condition: service_healthy
      tenant-service:
        condition: service_started
    restart: unless-stopped
    networks:
      - whatsapp_network

  whatsapp-api-service:
    build:
      context: .
      dockerfile: ./services/whatsapp-api-service/Dockerfile
    container_name: whatsapp-api
    ports:
      - "3008:3008"
    environment:
      PORT: 3008
      NODE_ENV: development
      REDIS_URL: redis://redis:6379
      TENANT_SERVICE_URL: http://tenant-service:3007
      RABBITMQ_URL: amqp://${RABBITMQ_USER:-admin}:${RABBITMQ_PASSWORD:-admin123}@rabbitmq:5672
    depends_on:
      - tenant-service
    restart: unless-stopped
    networks:
      - whatsapp_network

  # ==================== Genesys Services ====================

  genesys-webhook-service:
    build:
      context: .
      dockerfile: ./services/genesys-webhook-service/Dockerfile
    container_name: genesys-webhook
    ports:
      - "3011:3011"
    environment:
      PORT: 3011
      NODE_ENV: development
      RABBITMQ_URL: amqp://${RABBITMQ_USER:-admin}:${RABBITMQ_PASSWORD:-admin123}@rabbitmq:5672
      STATE_SERVICE_URL: http://state-manager:3005
      TENANT_SERVICE_URL: http://tenant-service:3007
      MINIO_ENDPOINT: minio
      MINIO_PORT: 9000
      MINIO_ACCESS_KEY: ${MINIO_ROOT_USER:-admin}
      MINIO_SECRET_KEY: ${MINIO_ROOT_PASSWORD:-admin123}
      MINIO_BUCKET: whatsapp-media
    depends_on:
      rabbitmq:
        condition: service_healthy
      state-manager:
        condition: service_started
      tenant-service:
        condition: service_started
    restart: unless-stopped
    networks:
      - whatsapp_network

  genesys-api-service:
    build:
      context: .
      dockerfile: ./services/genesys-api-service/Dockerfile
    container_name: genesys-api
    ports:
      - "3010:3010"
    environment:
      PORT: 3010
      NODE_ENV: development
      RABBITMQ_URL: amqp://${RABBITMQ_USER:-admin}:${RABBITMQ_PASSWORD:-admin123}@rabbitmq:5672
      REDIS_URL: redis://redis:6379
      TENANT_SERVICE_URL: http://tenant-service:3007
      AUTH_SERVICE_URL: http://auth-service:3004
    depends_on:
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
      tenant-service:
        condition: service_started
      auth-service:
        condition: service_started
    restart: unless-stopped
    networks:
      - whatsapp_network

  # ==================== Transformer Services ====================

  inbound-transformer:
    build:
      context: .
      dockerfile: ./services/inbound-transformer/Dockerfile
    container_name: whatsapp-inbound-transformer
    ports:
      - "3002:3002"
    environment:
      PORT: 3002
      NODE_ENV: development
      RABBITMQ_URL: amqp://${RABBITMQ_USER:-admin}:${RABBITMQ_PASSWORD:-admin123}@rabbitmq:5672
      STATE_SERVICE_URL: http://state-manager:3005
      GENESYS_API_URL: http://genesys-api:3010
    depends_on:
      rabbitmq:
        condition: service_healthy
      state-manager:
        condition: service_started
      genesys-api-service:
        condition: service_started
    restart: unless-stopped
    networks:
      - whatsapp_network

  outbound-transformer:
    build:
      context: .
      dockerfile: ./services/outbound-transformer/Dockerfile
    container_name: whatsapp-outbound-transformer
    ports:
      - "3003:3003"
    environment:
      PORT: 3003
      NODE_ENV: development
      RABBITMQ_URL: amqp://${RABBITMQ_USER:-admin}:${RABBITMQ_PASSWORD:-admin123}@rabbitmq:5672
      STATE_SERVICE_URL: http://state-manager:3005
      TENANT_SERVICE_URL: http://tenant-service:3007
      WHATSAPP_API_URL: http://whatsapp-api:3008
    depends_on:
      rabbitmq:
        condition: service_healthy
      state-manager:
        condition: service_started
      whatsapp-api-service:
        condition: service_started
    restart: unless-stopped
    networks:
      - whatsapp_network

  # ==================== API Gateway ====================

  api-gateway:
    build:
      context: .
      dockerfile: ./services/api-gateway/Dockerfile
      target: development
    container_name: whatsapp-api-gateway
    ports:
      - "3000:3000"
    environment:
      PORT: 3000
      NODE_ENV: development
      REDIS_URL: redis://redis:6379
      WHATSAPP_WEBHOOK_URL: http://whatsapp-webhook:3009
      WHATSAPP_API_URL: http://whatsapp-api:3008
      GENESYS_WEBHOOK_URL: http://genesys-webhook:3011
      GENESYS_API_URL: http://genesys-api:3010
      TENANT_SERVICE_URL: http://tenant-service:3007
      AUTH_SERVICE_URL: http://auth-service:3004
      STATE_SERVICE_URL: http://state-manager:3005
      AGENT_PORTAL_SERVICE_URL: http://agent-portal-service:3015
      ALLOWED_ORIGINS: http://localhost:3014,http://localhost:3013,http://localhost:3012,http://localhost:3314,http://localhost:3006
    depends_on:
      redis:
        condition: service_healthy
      tenant-service:
        condition: service_started
      auth-service:
        condition: service_started
    restart: unless-stopped
    networks:
      - whatsapp_network

  # ==================== Frontend Services ====================

  agent-widget:
    build:
      context: .
      dockerfile: ./services/agent-widget/Dockerfile
    container_name: whatsapp-agent-widget
    ports:
      - "3012:3012"
    environment:
      PORT: 3012
      NODE_ENV: development
      STATE_SERVICE_URL: http://state-manager:3005
      WHATSAPP_API_URL: http://whatsapp-api:3008
      PUBLIC_URL: ${WIDGET_PUBLIC_URL:-http://localhost:3012}
      ALLOWED_ORIGINS: http://localhost:3014,http://localhost:3000,http://agent-portal:80
    volumes:
      - ./services/agent-widget/src:/app/src:ro
    depends_on:
      - state-manager
      - whatsapp-api-service
    restart: unless-stopped
    networks:
      - whatsapp_network

  admin-dashboard:
    build:
      context: .
      dockerfile: ./services/admin-dashboard/Dockerfile
    container_name: whatsapp-admin-dashboard
    environment:
      REACT_APP_API_GATEWAY: http://localhost:3000
      VITE_API_GATEWAY: http://localhost:3000
      VITE_META_APP_ID: ${META_APP_ID}
      VITE_META_CONFIG_ID: ${META_CONFIG_ID}
    ports:
      - "3006:80"
    depends_on:
      - api-gateway
    restart: unless-stopped
    networks:
      - whatsapp_network

  agent-portal:
    build:
      context: .
      dockerfile: ./services/agent-portal/Dockerfile
    container_name: whatsapp-agent-portal
    ports:
      - "3014:80"
    environment:
      VITE_API_GATEWAY: http://localhost:3000
      VITE_AGENT_WIDGET_URL: ws://localhost:3012
      VITE_GENESYS_REGION: ${GENESYS_REGION:-mypurecloud.com}
    depends_on:
      - api-gateway
    restart: unless-stopped
    networks:
      - whatsapp_network

  agent-portal-service:
    build:
      context: .
      dockerfile: ./services/agent-portal-service/Dockerfile
    container_name: whatsapp-agent-portal-service
    ports:
      - "3015:3015"
    environment:
      PORT: 3015
      NODE_ENV: development
      DATABASE_URL: postgresql://postgres:${DB_PASSWORD:-secure_password}@postgres:5432/whatsapp_genesys
      REDIS_URL: redis://redis:6379
      RABBITMQ_URL: amqp://${RABBITMQ_USER:-admin}:${RABBITMQ_PASSWORD:-admin123}@rabbitmq:5672
      JWT_SECRET: ${JWT_SECRET:-your_secret_key_here_change_in_production}
      JWT_EXPIRES_IN: 7d
      GENESYS_CLIENT_ID: ${GENESYS_CLIENT_ID}
      GENESYS_CLIENT_SECRET: ${GENESYS_CLIENT_SECRET}
      GENESYS_REGION: ${GENESYS_REGION:-mypurecloud.com}
      GENESYS_REDIRECT_URI: ${GENESYS_AGENT_REDIRECT_URI:-http://localhost:3000/api/agents/auth/callback}
      AUTH_SERVICE_URL: http://auth-service:3004
      TENANT_SERVICE_URL: http://tenant-service:3007
      AGENT_WIDGET_URL: http://agent-widget:3012
      STATE_MANAGER_URL: http://state-manager:3005
      WHATSAPP_API_URL: http://whatsapp-api:3008
      AGENT_PORTAL_FRONTEND_URL: http://localhost:3014
      ALLOWED_ORIGINS: http://localhost:3014,http://localhost:3000,http://localhost:3012,http://localhost:5173
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      tenant-service:
        condition: service_started
      auth-service:
        condition: service_started
    restart: unless-stopped
    networks:
      - whatsapp_network

# ==================== Volumes ====================

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  rabbitmq_data:
    driver: local
  minio_data:
    driver: local

# ==================== Networks ====================

networks:
  whatsapp_network:
    driver: bridge
    name: whatsapp_genesys_network